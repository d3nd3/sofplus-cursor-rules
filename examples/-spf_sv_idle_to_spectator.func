// SoFplus

// ---------------------------------------------------------------------------
// Move idle players to spectator mode
// ---------------------------------------------------------------------------


//
// Init
//
function spf_sv_idle_to_spectator_init()
{
  sp_sc_func_exec spf_sc_list_add_func _sp_sv_on_map_begin "spf_sv_idle_to_spectator_on_map_begin"
  sp_sc_func_exec spf_sc_list_add_func _sp_sv_on_client_begin "spf_sv_idle_to_spectator_on_client_begin"

  sp_sc_exec_file sofplus/addons/spf_sv_idle_to_spectator.cfg
}


//
// Things to do when the map starts
//
function spf_sv_idle_to_spectator_on_map_begin()
{
  set _spf_sv_idle_to_spectator_nospec 6 // 6 * 10 seconds
  sp_sc_cvar_math_mul _spf_sv_idle_to_spectator_nospec #_spf_sv_idle_to_spectator_minutes
  set _spf_sv_idle_to_spectator_frames 600
  sp_sc_cvar_math_mul _spf_sv_idle_to_spectator_frames #_spf_sv_idle_to_spectator_minutes

  // Wait 10 seconds before the first check
  sset ~cmd "sp_sc_func_exec spf_sv_idle_to_spectator_check" #_sp_sv_info_map_count
  sp_sc_timer 10000 #~cmd
}


//
// Client begin
//
function spf_sv_idle_to_spectator_on_client_begin( ~par_slot )
{
  // Don't check client while this cvar is > 0
  set _spf_sv_idle_to_spectator_$~par_slot #_spf_sv_idle_to_spectator_nospec
}


//
// Start a new check
//
function spf_sv_idle_to_spectator_check( ~par_lc )
{
  // Don't run if the counters don't match
  sp_sc_flow_if number val #~par_lc == val #_sp_sv_info_map_count
  {
    // Check all current players
    set ~slot 0
    sp_sc_flow_while number cvar ~slot < val #maxclients
    {
      // Get player info
      zero _sp_sv_info_client_spectator
      sp_sv_info_client #~slot

      // Player exists and is not spectating?
      sp_sc_flow_if text val #_sp_sv_info_client_spectator == val "0"
      {
        // Don't check client while this cvar is > 0
        sp_sc_flow_if number cvar _spf_sv_idle_to_spectator_$~slot <= val 0
        {
          // Player idle for too long?
          sp_sc_flow_if number val #_sp_sv_info_client_frames_idle > val #_spf_sv_idle_to_spectator_frames
          {
            sp_sv_client_spec #~slot
            // Don't check client while this cvar is > 0
            set _spf_sv_idle_to_spectator_$~slot #_spf_sv_idle_to_spectator_nospec
          }
        }
        else
        {
          add _spf_sv_idle_to_spectator_$~slot -1
        }
      }
      else
      {
        // Don't check client while this cvar is > 0
        set _spf_sv_idle_to_spectator_$~slot #_spf_sv_idle_to_spectator_nospec
      }
      add ~slot 1
    }

    // Schedule next check in 10 seconds
    sset ~cmd "sp_sc_func_exec spf_sv_idle_to_spectator_check" #_sp_sv_info_map_count
    sp_sc_timer 10000 #~cmd
  }
}
